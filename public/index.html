<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–£—á—ë—Ç –æ–ø–µ—Ä–∞—Ü–∏–π –ø–æ —Ä–µ–∫–≤–∏–∑–∏—Ç–∞–º</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: var(--tg-theme-bg-color, #1a1a1a);
            color: var(--tg-theme-text-color, #e0e0e0);
            padding: 0;
            margin: 0;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .container {
            max-width: 100%;
            padding: 15px;
        }

        .header {
            background: var(--tg-theme-secondary-bg-color, #2d2d2d);
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 15px;
        }

        .user-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--tg-theme-button-color, #5c6bc0);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: bold;
            color: var(--tg-theme-button-text-color, white);
        }

        .user-name {
            font-size: 18px;
            font-weight: 600;
            color: var(--tg-theme-text-color, #e0e0e0);
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            overflow-x: auto;
        }

        .tab {
            padding: 10px 20px;
            border-radius: 8px;
            background: var(--tg-theme-secondary-bg-color, #3a3a3a);
            color: var(--tg-theme-text-color, #e0e0e0);
            border: none;
            cursor: pointer;
            white-space: nowrap;
            font-size: 14px;
        }

        .tab.active {
            background: var(--tg-theme-button-color, #5c6bc0);
            color: var(--tg-theme-button-text-color, white);
        }

        .summary {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .summary-card {
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            background: var(--tg-theme-secondary-bg-color, #2d2d2d);
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
        }

        .summary-card.income {
            background: linear-gradient(135deg, #1b5e20 0%, #2e7d32 100%);
        }

        .summary-card.spent {
            background: linear-gradient(135deg, #b71c1c 0%, #c62828 100%);
        }

        .summary-card.buyback {
            background: linear-gradient(135deg, #0d47a1 0%, #1976d2 100%);
        }

        .summary-card.earned {
            background: linear-gradient(135deg, #e65100 0%, #f57c00 100%);
        }

        .summary-card h3 {
            font-size: 0.75em;
            margin-bottom: 8px;
            color: rgba(255,255,255,0.8);
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .summary-card .amount {
            font-size: 1.4em;
            font-weight: 700;
            color: white;
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        .bank-list {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }

        .bank-card {
            padding: 15px;
            border-radius: 10px;
            background: var(--tg-theme-secondary-bg-color, #2d2d2d);
            text-align: center;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s;
        }

        .bank-card:active {
            opacity: 0.7;
        }

        .bank-card.selected {
            border-color: var(--tg-theme-button-color, #5c6bc0);
        }

        .bank-icon {
            font-size: 32px;
            margin-bottom: 8px;
        }

        .bank-name {
            font-size: 14px;
            font-weight: 500;
        }

        .card {
            background: var(--tg-theme-secondary-bg-color, #2d2d2d);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--tg-theme-hint-color, #4a4a4a);
        }

        .card-header h3 {
            color: var(--tg-theme-link-color, #90caf9);
            font-size: 1.1em;
            margin: 0;
        }

        .card-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .card-row label {
            color: var(--tg-theme-hint-color, #b0b0b0);
            font-size: 0.9em;
            flex: 0 0 45%;
        }

        .card-row input, .card-row select {
            width: 50%;
            padding: 8px;
            border: 1px solid var(--tg-theme-hint-color, #4a4a4a);
            border-radius: 6px;
            font-size: 14px;
            background: var(--tg-theme-bg-color, #1a1a1a);
            color: var(--tg-theme-text-color, #e0e0e0);
        }

        .card-row input:focus, .card-row select:focus {
            outline: none;
            border-color: var(--tg-theme-button-color, #5c6bc0);
        }

        .card-result {
            background: var(--tg-theme-bg-color, #1a1a1a);
            padding: 12px;
            border-radius: 8px;
            margin-top: 12px;
            text-align: center;
        }

        .card-result .label {
            color: var(--tg-theme-hint-color, #b0b0b0);
            font-size: 0.85em;
            margin-bottom: 5px;
        }

        .card-result .value {
            color: var(--tg-theme-link-color, #90caf9);
            font-size: 1.4em;
            font-weight: 700;
        }

        .btn {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .btn:active {
            opacity: 0.7;
        }

        .btn-primary {
            background: var(--tg-theme-button-color, #5c6bc0);
            color: var(--tg-theme-button-text-color, white);
            margin-bottom: 15px;
        }

        .btn-danger {
            background: #d32f2f;
            color: white;
            padding: 8px 16px;
            font-size: 14px;
            width: auto;
        }

        .requisite-item {
            background: var(--tg-theme-secondary-bg-color, #2d2d2d);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .requisite-info {
            flex: 1;
        }

        .requisite-bank {
            font-size: 12px;
            color: var(--tg-theme-hint-color, #b0b0b0);
        }

        .requisite-number {
            font-size: 16px;
            font-weight: 600;
            margin-top: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="user-info">
                <div class="user-avatar" id="userAvatar">?</div>
                <div class="user-name" id="userName">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            </div>
            
            <div class="summary">
                <div class="summary-card income">
                    <h3>–í—Ö–æ–¥</h3>
                    <div class="amount" id="totalIncome">0 ‚ÇΩ</div>
                </div>
                <div class="summary-card spent">
                    <h3>–ü–æ—Ç—Ä–∞—á–µ–Ω–æ</h3>
                    <div class="amount" id="totalSpent">0 ‚ÇΩ</div>
                </div>
                <div class="summary-card buyback">
                    <h3>–í—ã—Ö–æ–¥</h3>
                    <div class="amount" id="totalBuyback">0 ‚ÇΩ</div>
                </div>
                <div class="summary-card earned">
                    <h3>–ó–∞—Ä–∞–±–æ—Ç–∞–Ω–æ</h3>
                    <div class="amount" id="totalEarned">0 ‚ÇΩ</div>
                </div>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('records')">üìù –ó–∞–ø–∏—Å–∏</button>
            <button class="tab" onclick="switchTab('requisites')">üí≥ –†–µ–∫–≤–∏–∑–∏—Ç—ã</button>
            <button class="tab" onclick="switchTab('history')">üìä –ò—Å—Ç–æ—Ä–∏—è</button>
        </div>

        <!-- –†–∞–∑–¥–µ–ª: –ó–∞–ø–∏—Å–∏ -->
        <div id="recordsSection" class="section active">
            <div class="card">
                <div class="card-header">
                    <h3>–ù–æ–≤–∞—è –∑–∞–ø–∏—Å—å</h3>
                </div>
                <div class="card-row">
                    <label>–†–µ–∫–≤–∏–∑–∏—Ç:</label>
                    <select id="requisiteSelect">
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–∫–≤–∏–∑–∏—Ç</option>
                    </select>
                </div>
                <div class="card-row">
                    <label>–î–∞—Ç–∞:</label>
                    <input type="date" id="recordDate">
                </div>
                <div class="card-row">
                    <label>–í—Ö–æ–¥ (‚ÇΩ):</label>
                    <input type="number" id="recordIncome" value="0" min="0" step="0.01">
                </div>
                <div class="card-row">
                    <label>% –∑–∞—Ä–∞–±–æ—Ç–∫–∞:</label>
                    <input type="number" id="recordIncomePercent" value="11" min="0" max="100" step="0.01">
                </div>
                <div class="card-row">
                    <label>–ü–æ—Ç—Ä–∞—á–µ–Ω–æ (‚ÇΩ):</label>
                    <input type="number" id="recordSpent" value="0" min="0" step="0.01">
                </div>
                <div class="card-row">
                    <label>–í—ã—Ö–æ–¥ (‚ÇΩ):</label>
                    <input type="number" id="recordBuyback" value="0" min="0" step="0.01">
                </div>
                <div class="card-row">
                    <label>% –æ—Ç–∫—É–ø–∞:</label>
                    <input type="number" id="recordBuybackPercent" value="1" min="0" max="100" step="0.01">
                </div>
                <div class="card-result">
                    <div class="label">–ó–∞—Ä–∞–±–æ—Ç–∞–Ω–æ –∑–∞ –¥–µ–Ω—å</div>
                    <div class="value" id="recordEarned">0.00 ‚ÇΩ</div>
                </div>
            </div>
            <button class="btn btn-primary" onclick="addRecord()">‚ûï –î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å</button>
        </div>

        <!-- –†–∞–∑–¥–µ–ª: –†–µ–∫–≤–∏–∑–∏—Ç—ã -->
        <div id="requisitesSection" class="section">
            <div class="card">
                <div class="card-header">
                    <h3>–î–æ–±–∞–≤–∏—Ç—å —Ä–µ–∫–≤–∏–∑–∏—Ç</h3>
                </div>
                <div class="bank-list" id="bankList"></div>
                <div class="card-row">
                    <label>–ù–æ–º–µ—Ä —Ä–µ–∫–≤–∏–∑–∏—Ç–∞:</label>
                    <input type="text" id="requisiteNumber" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä">
                </div>
            </div>
            <button class="btn btn-primary" onclick="addRequisite()">‚ûï –î–æ–±–∞–≤–∏—Ç—å —Ä–µ–∫–≤–∏–∑–∏—Ç</button>
            
            <div class="card">
                <div class="card-header">
                    <h3>–ú–æ–∏ —Ä–µ–∫–≤–∏–∑–∏—Ç—ã</h3>
                </div>
                <div id="requisitesList"></div>
            </div>
        </div>

        <!-- –†–∞–∑–¥–µ–ª: –ò—Å—Ç–æ—Ä–∏—è -->
        <div id="historySection" class="section">
            <div class="card">
                <div class="card-header">
                    <h3>–§–∏–ª—å—Ç—Ä—ã</h3>
                </div>
                <div class="card-row">
                    <label>–î–∞—Ç–∞ –æ—Ç:</label>
                    <input type="date" id="filterDateFrom">
                </div>
                <div class="card-row">
                    <label>–î–∞—Ç–∞ –¥–æ:</label>
                    <input type="date" id="filterDateTo">
                </div>
                <div class="card-row">
                    <label>–†–µ–∫–≤–∏–∑–∏—Ç:</label>
                    <select id="filterRequisite">
                        <option value="">–í—Å–µ —Ä–µ–∫–≤–∏–∑–∏—Ç—ã</option>
                    </select>
                </div>
                <button class="btn btn-primary" onclick="applyFilters()">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
            </div>
            
            <div id="historyList"></div>
        </div>
    </div>

    <script>
        let tg = window.Telegram.WebApp;
        let currentUser = null;
        let userData = null;
        let selectedBank = null;
        
        const banks = [
            { id: 'ozon', name: '–û–∑–æ–Ω', icon: 'ÔøΩ' },
            { id: 'sber', name: '–°–±–µ—Ä–±–∞–Ω–∫', icon: 'ÔøΩ' },
            { id: 'alpha', name: '–ê–ª—å—Ñ–∞', icon: 'üî¥' },
            { id: 'tinkoff', name: '–¢–∏–Ω—å–∫–æ—Ñ—Ñ', icon: 'ÔøΩ' },
            { id: 'vtb', name: '–í–¢–ë', icon: '‚ö™' },
            { id: 'other', name: '–î—Ä—É–≥–æ–π', icon: '‚ö´' }
        ];

        let appData = {
            requisites: [],
            records: []
        };

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        tg.ready();
        tg.expand();
        document.body.style.backgroundColor = tg.backgroundColor || '#1a1a1a';

        if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
            userData = tg.initDataUnsafe.user;
            currentUser = 'tg_' + userData.id;
            const firstName = userData.first_name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
            const lastName = userData.last_name || '';
            document.getElementById('userName').textContent = firstName + (lastName ? ' ' + lastName : '');
            document.getElementById('userAvatar').textContent = firstName.charAt(0).toUpperCase();
            loadData();
        } else {
            document.getElementById('userName').textContent = '–ì–æ—Å—Ç—å';
            document.getElementById('userAvatar').textContent = '–ì';
            currentUser = 'guest_' + Date.now();
            loadData();
        }

        // –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–µ–≥–æ–¥–Ω—è—à–Ω—é—é –¥–∞—Ç—É
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('recordDate').value = today;
        document.getElementById('filterDateFrom').value = today;
        document.getElementById('filterDateTo').value = today;

        // –û—Ç—Ä–∏—Å–æ–≤–∞—Ç—å –±–∞–Ω–∫–∏
        function renderBanks() {
            const bankList = document.getElementById('bankList');
            bankList.innerHTML = banks.map(bank => `
                <div class="bank-card" onclick="selectBank('${bank.id}')">
                    <div class="bank-icon">${bank.icon}</div>
                    <div class="bank-name">${bank.name}</div>
                </div>
            `).join('');
        }

        function selectBank(bankId) {
            selectedBank = bankId;
            document.querySelectorAll('.bank-card').forEach(card => {
                card.classList.remove('selected');
            });
            event.target.closest('.bank-card').classList.add('selected');
            if (tg.HapticFeedback) tg.HapticFeedback.impactOccurred('light');
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tab + 'Section').classList.add('active');
            
            if (tab === 'history') {
                renderHistory();
            }
            if (tg.HapticFeedback) tg.HapticFeedback.impactOccurred('light');
        }

        function addRequisite() {
            if (!selectedBank) {
                if (tg.showAlert) tg.showAlert('–í—ã–±–µ—Ä–∏—Ç–µ –±–∞–Ω–∫');
                return;
            }
            
            const number = document.getElementById('requisiteNumber').value.trim();
            if (!number) {
                if (tg.showAlert) tg.showAlert('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Ä–µ–∫–≤–∏–∑–∏—Ç–∞');
                return;
            }

            const bank = banks.find(b => b.id === selectedBank);
            const requisite = {
                id: Date.now(),
                bankId: selectedBank,
                bankName: bank.name,
                bankIcon: bank.icon,
                number: number,
                createdAt: new Date().toISOString()
            };

            appData.requisites.push(requisite);
            document.getElementById('requisiteNumber').value = '';
            selectedBank = null;
            document.querySelectorAll('.bank-card').forEach(card => card.classList.remove('selected'));
            
            renderRequisites();
            updateRequisiteSelects();
            saveData();
            if (tg.HapticFeedback) tg.HapticFeedback.impactOccurred('medium');
        }

        function renderRequisites() {
            const list = document.getElementById('requisitesList');
            if (appData.requisites.length === 0) {
                list.innerHTML = '<p style="text-align:center;color:var(--tg-theme-hint-color,#888);padding:20px;">–ù–µ—Ç —Ä–µ–∫–≤–∏–∑–∏—Ç–æ–≤</p>';
                return;
            }
            
            list.innerHTML = appData.requisites.map(req => `
                <div class="requisite-item">
                    <div class="requisite-info">
                        <div class="requisite-bank">${req.bankIcon} ${req.bankName}</div>
                        <div class="requisite-number">${req.number}</div>
                    </div>
                    <button class="btn-danger" onclick="deleteRequisite(${req.id})">–£–¥–∞–ª–∏—Ç—å</button>
                </div>
            `).join('');
        }

        function deleteRequisite(id) {
            appData.requisites = appData.requisites.filter(r => r.id !== id);
            renderRequisites();
            updateRequisiteSelects();
            saveData();
            if (tg.HapticFeedback) tg.HapticFeedback.impactOccurred('medium');
        }

        function updateRequisiteSelects() {
            const selects = [document.getElementById('requisiteSelect'), document.getElementById('filterRequisite')];
            selects.forEach(select => {
                const currentValue = select.value;
                const isFilter = select.id === 'filterRequisite';
                select.innerHTML = `<option value="">${isFilter ? '–í—Å–µ —Ä–µ–∫–≤–∏–∑–∏—Ç—ã' : '–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–∫–≤–∏–∑–∏—Ç'}</option>` +
                    appData.requisites.map(req => 
                        `<option value="${req.id}">${req.bankIcon} ${req.bankName} - ${req.number}</option>`
                    ).join('');
                select.value = currentValue;
            });
        }

        function calculateRecord() {
            const income = parseFloat(document.getElementById('recordIncome').value) || 0;
            const incomePercent = parseFloat(document.getElementById('recordIncomePercent').value) || 0;
            const spent = parseFloat(document.getElementById('recordSpent').value) || 0;
            const buyback = parseFloat(document.getElementById('recordBuyback').value) || 0;
            const buybackPercent = parseFloat(document.getElementById('recordBuybackPercent').value) || 0;

            const earnedFromIncome = (income * incomePercent) / 100;
            const earnedFromBuyback = (buyback * buybackPercent) / 100;
            const totalEarned = earnedFromIncome + earnedFromBuyback - spent;
            
            document.getElementById('recordEarned').textContent = totalEarned.toFixed(2) + ' ‚ÇΩ';
        }

        document.getElementById('recordIncome').addEventListener('input', calculateRecord);
        document.getElementById('recordIncomePercent').addEventListener('input', calculateRecord);
        document.getElementById('recordSpent').addEventListener('input', calculateRecord);
        document.getElementById('recordBuyback').addEventListener('input', calculateRecord);
        document.getElementById('recordBuybackPercent').addEventListener('input', calculateRecord);

        function addRecord() {
            const requisiteId = document.getElementById('requisiteSelect').value;
            if (!requisiteId) {
                if (tg.showAlert) tg.showAlert('–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–∫–≤–∏–∑–∏—Ç');
                return;
            }

            const requisite = appData.requisites.find(r => r.id == requisiteId);
            const date = document.getElementById('recordDate').value;
            const income = parseFloat(document.getElementById('recordIncome').value) || 0;
            const incomePercent = parseFloat(document.getElementById('recordIncomePercent').value) || 0;
            const spent = parseFloat(document.getElementById('recordSpent').value) || 0;
            const buyback = parseFloat(document.getElementById('recordBuyback').value) || 0;
            const buybackPercent = parseFloat(document.getElementById('recordBuybackPercent').value) || 0;

            const earnedFromIncome = (income * incomePercent) / 100;
            const earnedFromBuyback = (buyback * buybackPercent) / 100;
            const totalEarned = earnedFromIncome + earnedFromBuyback - spent;

            const record = {
                id: Date.now(),
                requisiteId: requisite.id,
                requisiteName: `${requisite.bankIcon} ${requisite.bankName} - ${requisite.number}`,
                date: date,
                income: income,
                incomePercent: incomePercent,
                spent: spent,
                buyback: buyback,
                buybackPercent: buybackPercent,
                earned: totalEarned,
                createdAt: new Date().toISOString()
            };

            appData.records.push(record);

            // –°–±—Ä–æ—Å —Ñ–æ—Ä–º—ã
            document.getElementById('recordIncome').value = 0;
            document.getElementById('recordIncomePercent').value = 11;
            document.getElementById('recordSpent').value = 0;
            document.getElementById('recordBuyback').value = 0;
            document.getElementById('recordBuybackPercent').value = 1;
            calculateRecord();

            updateSummary();
            saveData();
            if (tg.showAlert) tg.showAlert('–ó–∞–ø–∏—Å—å –¥–æ–±–∞–≤–ª–µ–Ω–∞!');
            if (tg.HapticFeedback) tg.HapticFeedback.impactOccurred('medium');
        }

        function updateSummary() {
            let totalIncome = 0;
            let totalSpent = 0;
            let totalBuyback = 0;
            let totalEarned = 0;

            appData.records.forEach(record => {
                totalIncome += record.income;
                totalSpent += record.spent;
                totalBuyback += record.buyback;
                totalEarned += record.earned;
            });

            document.getElementById('totalIncome').textContent = totalIncome.toFixed(2) + ' ‚ÇΩ';
            document.getElementById('totalSpent').textContent = totalSpent.toFixed(2) + ' ‚ÇΩ';
            document.getElementById('totalBuyback').textContent = totalBuyback.toFixed(2) + ' ‚ÇΩ';
            document.getElementById('totalEarned').textContent = totalEarned.toFixed(2) + ' ‚ÇΩ';
        }

        function renderHistory() {
            applyFilters();
        }

        function applyFilters() {
            const dateFrom = document.getElementById('filterDateFrom').value;
            const dateTo = document.getElementById('filterDateTo').value;
            const requisiteId = document.getElementById('filterRequisite').value;

            let filtered = appData.records.filter(record => {
                if (dateFrom && record.date < dateFrom) return false;
                if (dateTo && record.date > dateTo) return false;
                if (requisiteId && record.requisiteId != requisiteId) return false;
                return true;
            });

            // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –¥–∞—Ç–µ (–Ω–æ–≤—ã–µ —Å–≤–µ—Ä—Ö—É)
            filtered.sort((a, b) => new Date(b.date) - new Date(a.date));

            const list = document.getElementById('historyList');
            if (filtered.length === 0) {
                list.innerHTML = '<div class="card"><p style="text-align:center;color:var(--tg-theme-hint-color,#888);padding:20px;">–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π</p></div>';
                return;
            }

            // –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ –¥–∞—Ç–∞–º
            const grouped = {};
            filtered.forEach(record => {
                if (!grouped[record.date]) {
                    grouped[record.date] = [];
                }
                grouped[record.date].push(record);
            });

            list.innerHTML = Object.keys(grouped).map(date => {
                const records = grouped[date];
                const dayTotal = records.reduce((sum, r) => sum + r.earned, 0);
                
                return `
                    <div class="card">
                        <div class="card-header">
                            <h3>üìÖ ${formatDate(date)}</h3>
                            <span style="color: var(--tg-theme-link-color, #90caf9); font-weight: 700;">${dayTotal.toFixed(2)} ‚ÇΩ</span>
                        </div>
                        ${records.map(record => `
                            <div style="background: var(--tg-theme-bg-color, #1a1a1a); padding: 12px; border-radius: 8px; margin-bottom: 10px;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                    <span style="font-weight: 600;">${record.requisiteName}</span>
                                    <button class="btn-danger" onclick="deleteRecord(${record.id})">–£–¥–∞–ª–∏—Ç—å</button>
                                </div>
                                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; font-size: 13px; color: var(--tg-theme-hint-color, #b0b0b0);">
                                    <div>–í—Ö–æ–¥: ${record.income.toFixed(2)} ‚ÇΩ</div>
                                    <div>% –∑–∞—Ä–∞–±–æ—Ç–∫–∞: ${record.incomePercent}%</div>
                                    <div>–ü–æ—Ç—Ä–∞—á–µ–Ω–æ: ${record.spent.toFixed(2)} ‚ÇΩ</div>
                                    <div>–í—ã—Ö–æ–¥: ${record.buyback.toFixed(2)} ‚ÇΩ</div>
                                    <div>% –æ—Ç–∫—É–ø–∞: ${record.buybackPercent}%</div>
                                    <div style="color: var(--tg-theme-link-color, #90caf9); font-weight: 600;">–ó–∞—Ä–∞–±–æ—Ç–∞–Ω–æ: ${record.earned.toFixed(2)} ‚ÇΩ</div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }).join('');
        }

        function deleteRecord(id) {
            appData.records = appData.records.filter(r => r.id !== id);
            updateSummary();
            renderHistory();
            saveData();
            if (tg.HapticFeedback) tg.HapticFeedback.impactOccurred('medium');
        }

        function formatDate(dateStr) {
            const date = new Date(dateStr);
            const options = { day: 'numeric', month: 'long', year: 'numeric' };
            return date.toLocaleDateString('ru-RU', options);
        }

        async function saveData() {
            if (!currentUser) return;
            
            try {
                await fetch(`/api/data/${currentUser}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        requisites: appData.requisites,
                        records: appData.records,
                        userData: userData
                    })
                });
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', error);
            }
        }

        async function loadData() {
            if (!currentUser) return;
            
            try {
                const response = await fetch(`/api/data/${currentUser}`);
                const savedData = await response.json();
                
                if (savedData.requisites) {
                    appData.requisites = savedData.requisites;
                }
                if (savedData.records) {
                    appData.records = savedData.records;
                }
                
                renderBanks();
                renderRequisites();
                updateRequisiteSelects();
                updateSummary();
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', error);
                renderBanks();
            }
        }
    </script>
</body>
</html>
